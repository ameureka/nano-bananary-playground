# ç‹¬ç«‹åº”ç”¨ MkSaaS é›†æˆé¢„å¤‡è®¾è®¡ - 13 è¦ç´ æ·±åº¦åˆ†æ

> **æ–‡æ¡£ç›®æ ‡**: ä¸ºç‹¬ç«‹åº”ç”¨è®¾è®¡é˜¶æ®µæä¾›å®Œæ•´çš„ MkSaaS é›†æˆé¢„å¤‡æŒ‡å—  
> **é€‚ç”¨åœºæ™¯**: åœ¨ Cloudflare ä¸Šç‹¬ç«‹è¿è¡Œï¼Œä½†é¢„ç•™æœªæ¥é›†æˆ MkSaaS çš„èƒ½åŠ›  
> **ç”Ÿæˆæ—¥æœŸ**: 2025-10-17  
> **åŸºäº**: MkSaaS 78 ä¸ªé…ç½®ä»»åŠ¡çš„æ·±åº¦åˆ†æ

---

## ğŸ“‹ æ–‡æ¡£è¯´æ˜

æœ¬æ–‡æ¡£åŸºäºå¯¹ MkSaaS æ¡†æ¶ 78 ä¸ªé…ç½®ä»»åŠ¡çš„æ·±å…¥ç ”ç©¶ï¼Œæç‚¼å‡º 13 ä¸ªåœ¨ç‹¬ç«‹åº”ç”¨è®¾è®¡é˜¶æ®µå°±å¿…é¡»è€ƒè™‘çš„å…³é”®å› ç´ ã€‚è¿™äº›å› ç´ æŒ‰ç…§**ç´§æ€¥åº¦ã€éš¾åº¦ã€é›†æˆå½±å“ã€æŠ•å…¥äº§å‡ºæ¯”**è¿›è¡Œäº†ç§‘å­¦è¯„ä¼°ã€‚

### æ ¸å¿ƒç†å¿µ

```
è®¾è®¡é˜¶æ®µçš„æ­£ç¡®å†³ç­– = æœªæ¥é›†æˆçš„å¹³æ»‘è¿‡æ¸¡
```

**é¿å…çš„é™·é˜±**ï¼š
- âŒ åªå…³æ³¨å½“å‰éœ€æ±‚ï¼Œå¿½è§†æœªæ¥æ‰©å±•
- âŒ è¿‡åº¦è®¾è®¡ï¼Œå¢åŠ ä¸å¿…è¦çš„å¤æ‚åº¦
- âŒ ç¡¬ç¼–ç ä¸šåŠ¡é€»è¾‘ï¼Œéš¾ä»¥é…ç½®åŒ–

**æ­£ç¡®çš„ç­–ç•¥**ï¼š
- âœ… é¢„ç•™æ¥å£ï¼Œä½†ä¸è¿‡åº¦å®ç°
- âœ… ä½¿ç”¨æ ‡å‡†åŒ–å‘½åå’Œç»“æ„
- âœ… å…³æ³¨ç‚¹åˆ†ç¦»ï¼Œæ¨¡å—åŒ–è®¾è®¡

---

## ğŸ¯ 13 è¦ç´ ä¼˜å…ˆçº§æ€»è§ˆ

| # | è¦ç´  | ç´§æ€¥åº¦ | éš¾åº¦ | é›†æˆå½±å“ | æŠ•å…¥ | æ”¶ç›Š | æ‰§è¡Œé˜¶æ®µ |
|---|------|--------|------|---------|------|------|---------|
| 1 | æ•°æ®åº“è®¾è®¡ | ğŸ”´ğŸ”´ğŸ”´ | ğŸŸ¡ | æé«˜ | 2-3å¤© | èŠ‚çœ2-3å‘¨ | ç¬¬1å‘¨ |
| 2 | API è®¾è®¡æ¨¡å¼ | ğŸ”´ğŸ”´ | ğŸŸ¡ | é«˜ | 1-2å¤© | èŠ‚çœ1-2å‘¨ | ç¬¬1å‘¨ |
| 3 | ç¯å¢ƒå˜é‡ç®¡ç† | ğŸŸ¡ | ğŸŸ¢ | ä¸­ | 2-4å°æ—¶ | èŠ‚çœ2-3å¤© | ç¬¬1å‘¨ |
| 4 | æ–‡ä»¶å­˜å‚¨ç­–ç•¥ | ğŸŸ¡ | ğŸŸ¢ | ä¸­ | 1å¤© | èŠ‚çœ3-5å¤© | ç¬¬1å‘¨ |
| 5 | å‰ç«¯çŠ¶æ€ç®¡ç† | ğŸŸ¢ | ğŸŸ¡ | ä½ | 1-2å¤© | èŠ‚çœ1å‘¨ | ç¬¬2å‘¨ |
| 6 | é”™è¯¯å¤„ç† | ğŸŸ¢ | ğŸŸ¢ | ä½ | 4-6å°æ—¶ | èŠ‚çœ2-3å¤© | ç¬¬2å‘¨ |
| 7 | å›½é™…åŒ–æ¶æ„ | ğŸ”´ğŸ”´ | ğŸŸ¡ | é«˜ | 1-2å¤© | èŠ‚çœ1-2å‘¨ | ç¬¬1å‘¨ |
| 8 | å…ƒæ•°æ®/SEO | ğŸŸ¡ | ğŸŸ¢ | ä¸­ | 4-6å°æ—¶ | èŠ‚çœ2-3å¤© | ç¬¬1å‘¨ |
| 9 | ä¸»é¢˜ç³»ç»Ÿ | ğŸŸ¡ | ğŸŸ¢ | ä¸­ | åŠå¤© | èŠ‚çœ3-5å¤© | ç¬¬1å‘¨ |
| 10 | é…ç½®é©±åŠ¨ | ğŸŸ¢ | ğŸŸ¢ | ä½ | 2-4å°æ—¶ | èŠ‚çœ1-2å¤© | ç¬¬2å‘¨ |
| 11 | ç”¨æˆ·åå¥½ | ğŸŸ¢ | ğŸŸ¢ | ä½ | 2-3å°æ—¶ | èŠ‚çœ1å¤© | ç¬¬2å‘¨ |
| 12 | åˆ†æåŸ‹ç‚¹ | ğŸŸ¢ | ğŸŸ¢ | ä½ | 2-3å°æ—¶ | èŠ‚çœ2-3å¤© | ç¬¬2å‘¨ |
| 13 | æ³•å¾‹åˆè§„ | ğŸŸ¢ | ğŸŸ¢ | ä½ | 1-2å°æ—¶ | èŠ‚çœ1-2å¤© | ç¬¬3å‘¨ |

**æ€»æŠ•å…¥**: çº¦ 10-15 å¤©  
**æœªæ¥æ”¶ç›Š**: èŠ‚çœ 5-8 å‘¨çš„é‡æ„æ—¶é—´  
**æŠ•èµ„å›æŠ¥ç‡**: çº¦ 300-400%

---

## ğŸ”´ è¦ç´  1ï¼šæ•°æ®åº“è®¾è®¡ï¼ˆæœ€å…³é”®ï¼ï¼‰

### ä¸ºä»€ä¹ˆæ˜¯æœ€é«˜ä¼˜å…ˆçº§ï¼Ÿ

**åŸå› åˆ†æ**ï¼š
1. **æ”¹é€ æˆæœ¬æé«˜**ï¼šæ•°æ®åº“ç»“æ„ä¸€æ—¦ä¸Šçº¿ï¼Œä¿®æ”¹éœ€è¦æ•°æ®è¿ç§»
2. **å½±å“èŒƒå›´æœ€å¹¿**ï¼šå½±å“æ‰€æœ‰ä¸šåŠ¡é€»è¾‘ã€API è®¾è®¡ã€å‰ç«¯å±•ç¤º
3. **MkSaaS æ ¸å¿ƒä¾èµ–**ï¼šç”¨æˆ·ç³»ç»Ÿã€æ”¯ä»˜ã€ç§¯åˆ†éƒ½ä¾èµ–æ•°æ®åº“è®¾è®¡
4. **æŠ€æœ¯å€ºåŠ¡æºå¤´**ï¼šé”™è¯¯çš„æ•°æ®åº“è®¾è®¡ä¼šå¯¼è‡´é•¿æœŸæŠ€æœ¯å€ºåŠ¡

**MkSaaS æ•°æ®åº“ç‰¹ç‚¹**ï¼š
- ä½¿ç”¨ **Drizzle ORM** + **PostgreSQL**
- æ‰€æœ‰ä¸šåŠ¡è¡¨éƒ½å…³è” `userId`
- ä½¿ç”¨ **UUID** ä½œä¸ºä¸»é”®
- å¤§é‡ä½¿ç”¨ **JSONB** å­˜å‚¨çµæ´»æ•°æ®
- å®Œå–„çš„**æ—¶é—´æˆ³**å’Œ**è½¯åˆ é™¤**æœºåˆ¶

### è®¾è®¡åŸåˆ™

#### åŸåˆ™ 1ï¼šæ‰€æœ‰æ ¸å¿ƒä¸šåŠ¡è¡¨é¢„ç•™ `userId` å­—æ®µ

```typescript
// âŒ é”™è¯¯è®¾è®¡ï¼ˆæ— ç”¨æˆ·å…³è”ï¼‰
interface Asset {
  id: string;
  imageUrl: string;
  prompt: string;
  createdAt: Date;
}

// âœ… æ­£ç¡®è®¾è®¡ï¼ˆé¢„ç•™ç”¨æˆ·å­—æ®µï¼‰
interface Asset {
  id: string;
  userId: string | null;  // ğŸ”‘ å…³é”®ï¼šç°åœ¨å¯ä»¥ä¸º nullï¼Œæœªæ¥å¿…å¡«
  imageUrl: string;
  prompt: string;
  metadata: Record<string, any>;  // ğŸ”‘ çµæ´»çš„å…ƒæ•°æ®
  createdAt: Date;
  updatedAt: Date;
  deletedAt: Date | null;  // ğŸ”‘ è½¯åˆ é™¤
}
```

**ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ**
- `userId` ç°åœ¨å¯ä»¥æ˜¯ `null` æˆ–é»˜è®¤å€¼ï¼ˆå¦‚ `'anonymous'`ï¼‰
- æœªæ¥é›†æˆæ—¶åªéœ€ï¼š
  1. æ·»åŠ å¤–é”®çº¦æŸ
  2. æ›´æ–°ç°æœ‰è®°å½•çš„ `userId`
  3. ä¿®æ”¹ä¸º `NOT NULL`

#### åŸåˆ™ 2ï¼šä½¿ç”¨ UUID è€Œéè‡ªå¢ ID

```typescript
// âŒ é”™è¯¯ï¼ˆè‡ªå¢ IDï¼‰
CREATE TABLE assets (
  id SERIAL PRIMARY KEY,  -- è¿ç§»æ—¶ä¼šå†²çª
  ...
);

// âœ… æ­£ç¡®ï¼ˆUUIDï¼‰
CREATE TABLE assets (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  ...
);

// TypeScript ä¸­
import { pgTable, uuid, text, timestamp } from 'drizzle-orm/pg-core';

export const assets = pgTable('assets', {
  id: uuid('id').primaryKey().defaultRandom(),
  userId: uuid('user_id'),  // æœªæ¥å…³è” users è¡¨
  // ...
});
```

**ä¸ºä»€ä¹ˆä½¿ç”¨ UUIDï¼Ÿ**
- MkSaaS ä½¿ç”¨ UUID
- é¿å… ID å†²çª
- æ”¯æŒåˆ†å¸ƒå¼ç³»ç»Ÿ
- æ›´å¥½çš„å®‰å…¨æ€§ï¼ˆä¸å¯é¢„æµ‹ï¼‰

#### åŸåˆ™ 3ï¼šæ·»åŠ  metadata JSONB å­—æ®µ

```typescript
export const assets = pgTable('assets', {
  id: uuid('id').primaryKey().defaultRandom(),
  userId: uuid('user_id'),
  
  // æ ¸å¿ƒå­—æ®µ
  type: text('type').notNull(),  // 'image' | 'video'
  url: text('url').notNull(),
  
  // ğŸ”‘ çµæ´»çš„å…ƒæ•°æ®å­—æ®µ
  metadata: jsonb('metadata').$type<{
    // ç°åœ¨éœ€è¦çš„å­—æ®µ
    width?: number;
    height?: number;
    fileSize?: number;
    prompt?: string;
    effect?: string;
    
    // æœªæ¥å¯èƒ½éœ€è¦çš„å­—æ®µï¼ˆä¸éœ€è¦ä¿®æ”¹è¡¨ç»“æ„ï¼‰
    subscriptionTier?: string;
    creditsUsed?: number;
    generationTime?: number;
    aiModel?: string;
  }>(),
  
  // æ—¶é—´æˆ³
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
  deletedAt: timestamp('deleted_at'),  // è½¯åˆ é™¤
});
```

**ä¸ºä»€ä¹ˆä½¿ç”¨ JSONBï¼Ÿ**
- çµæ´»å­˜å‚¨æ‰©å±•ä¿¡æ¯
- æ— éœ€é¢‘ç¹ä¿®æ”¹è¡¨ç»“æ„
- PostgreSQL å¯¹ JSONB æœ‰è‰¯å¥½çš„ç´¢å¼•æ”¯æŒ
- MkSaaS å¤§é‡ä½¿ç”¨è¿™ä¸ªæ¨¡å¼



### å®Œæ•´æ•°æ®è¡¨è®¾è®¡ç¤ºä¾‹

#### Assets è¡¨ï¼ˆèµ„äº§è¡¨ï¼‰

```typescript
// db/schema/assets.ts
import { pgTable, uuid, text, timestamp, jsonb, integer, index } from 'drizzle-orm/pg-core';

export const assets = pgTable('assets', {
  // ä¸»é”®
  id: uuid('id').primaryKey().defaultRandom(),
  
  // ç”¨æˆ·å…³è”ï¼ˆç°åœ¨å¯ä¸º nullï¼‰
  userId: uuid('user_id'),  // æœªæ¥æ·»åŠ : .references(() => users.id, { onDelete: 'cascade' })
  
  // èµ„äº§ä¿¡æ¯
  type: text('type').notNull(),  // 'image' | 'video'
  url: text('url').notNull(),
  thumbnailUrl: text('thumbnail_url'),
  
  // ç”Ÿæˆä¿¡æ¯
  prompt: text('prompt'),
  effect: text('effect'),
  
  // çµæ´»çš„å…ƒæ•°æ®
  metadata: jsonb('metadata').$type<{
    width?: number;
    height?: number;
    fileSize?: number;
    mimeType?: string;
    aspectRatio?: string;
    generationTime?: number;
    aiModel?: string;
    // æœªæ¥æ‰©å±•å­—æ®µ
    creditsUsed?: number;
    subscriptionTier?: string;
  }>(),
  
  // ç»Ÿè®¡ï¼ˆå¯é€‰ï¼‰
  viewCount: integer('view_count').default(0),
  downloadCount: integer('download_count').default(0),
  
  // æ—¶é—´æˆ³
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
  deletedAt: timestamp('deleted_at'),  // è½¯åˆ é™¤
}, (table) => ({
  // ç´¢å¼•ï¼ˆæå‰è§„åˆ’ï¼‰
  userIdIdx: index('assets_user_id_idx').on(table.userId),
  createdAtIdx: index('assets_created_at_idx').on(table.createdAt),
  typeIdx: index('assets_type_idx').on(table.type),
}));

// TypeScript ç±»å‹æ¨å¯¼
export type Asset = typeof assets.$inferSelect;
export type NewAsset = typeof assets.$inferInsert;
```

#### User Preferences è¡¨ï¼ˆç”¨æˆ·åå¥½ï¼‰

```typescript
// db/schema/user-preferences.ts
export const userPreferences = pgTable('user_preferences', {
  id: uuid('id').primaryKey().defaultRandom(),
  userId: uuid('user_id'),  // ç°åœ¨å¯ä»¥ç”¨ session IDï¼Œæœªæ¥ç”¨çœŸå® userId
  
  // UI åå¥½
  theme: text('theme').default('light'),  // 'light' | 'dark' | 'system'
  language: text('language').default('en'),
  
  // ä¸šåŠ¡åå¥½
  defaultEffect: text('default_effect'),
  defaultAspectRatio: text('default_aspect_ratio').default('Auto'),
  autoSaveAssets: boolean('auto_save_assets').default(true),
  
  // é€šçŸ¥åå¥½ï¼ˆæœªæ¥ç”¨ï¼‰
  emailNotifications: boolean('email_notifications').default(true),
  
  // æ—¶é—´æˆ³
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
});
```

### æ•°æ®åº“é€‰æ‹©å»ºè®®

#### é€‰é¡¹å¯¹æ¯”

| æ•°æ®åº“ | ä¼˜åŠ¿ | åŠ£åŠ¿ | æ¨èåº¦ |
|--------|------|------|--------|
| **Neon (PostgreSQL)** | å…è´¹å±‚æ…·æ…¨ã€è‡ªåŠ¨æ‰©å±•ã€ä¸ MkSaaS å®Œå…¨å…¼å®¹ | éœ€è¦ç½‘ç»œè¿æ¥ | â­â­â­â­â­ |
| **Supabase (PostgreSQL)** | åŠŸèƒ½ä¸°å¯Œã€å®æ—¶è®¢é˜…ã€è®¤è¯é›†æˆ | ç¨å¤æ‚ | â­â­â­â­ |
| **Cloudflare D1 (SQLite)** | è¾¹ç¼˜è®¡ç®—ã€ä½å»¶è¿Ÿ | éœ€è¦è¿ç§»åˆ° PostgreSQL | â­â­â­ |
| **Turso (SQLite)** | è¾¹ç¼˜å¤åˆ¶ã€ä½å»¶è¿Ÿ | éœ€è¦è¿ç§»åˆ° PostgreSQL | â­â­â­ |

**æ¨èæ–¹æ¡ˆ**ï¼š**Neon PostgreSQL**

**ç†ç”±**ï¼š
1. âœ… ä¸ MkSaaS å®Œå…¨å…¼å®¹ï¼ˆéƒ½ç”¨ PostgreSQLï¼‰
2. âœ… å…è´¹å±‚è¶³å¤Ÿå¼€å‘å’Œæµ‹è¯•
3. âœ… æ— éœ€æ•°æ®è¿ç§»
4. âœ… æ”¯æŒæ‰€æœ‰ PostgreSQL ç‰¹æ€§ï¼ˆJSONBã€UUID ç­‰ï¼‰
5. âœ… è‡ªåŠ¨å¤‡ä»½å’Œæ‰©å±•

### è¿ç§»ç­–ç•¥

#### ç°åœ¨ï¼ˆç‹¬ç«‹åº”ç”¨é˜¶æ®µï¼‰

```typescript
// drizzle.config.ts
import type { Config } from 'drizzle-kit';

export default {
  schema: './db/schema/*',
  out: './db/migrations',
  driver: 'pg',
  dbCredentials: {
    connectionString: process.env.DATABASE_URL!,
  },
} satisfies Config;

// åˆ›å»ºè¿ç§»
// npm run db:generate
// npm run db:migrate
```

#### æœªæ¥ï¼ˆé›†æˆ MkSaaS é˜¶æ®µï¼‰

```typescript
// 1. æ·»åŠ å¤–é”®çº¦æŸ
ALTER TABLE assets 
ADD CONSTRAINT assets_user_id_fkey 
FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE;

// 2. æ›´æ–°ç°æœ‰æ•°æ®ï¼ˆå°† anonymous ç”¨æˆ·è¿ç§»ï¼‰
UPDATE assets 
SET user_id = (SELECT id FROM users WHERE email = 'migration@example.com')
WHERE user_id IS NULL;

// 3. è®¾ç½®ä¸º NOT NULL
ALTER TABLE assets 
ALTER COLUMN user_id SET NOT NULL;
```

### å®æ–½æ£€æŸ¥æ¸…å•

- [ ] æ‰€æœ‰ä¸šåŠ¡è¡¨éƒ½æœ‰ `userId` å­—æ®µï¼ˆnullableï¼‰
- [ ] ä½¿ç”¨ UUID ä½œä¸ºä¸»é”®
- [ ] æ·»åŠ  `metadata` JSONB å­—æ®µ
- [ ] æ·»åŠ  `createdAt`, `updatedAt`, `deletedAt` æ—¶é—´æˆ³
- [ ] åˆ›å»ºå¿…è¦çš„ç´¢å¼•
- [ ] ä½¿ç”¨ Drizzle ORM
- [ ] é€‰æ‹© PostgreSQLï¼ˆæ¨è Neonï¼‰
- [ ] ç¼–å†™æ•°æ®åº“è¿ç§»è„šæœ¬
- [ ] æµ‹è¯•è½¯åˆ é™¤é€»è¾‘

**ç´§æ€¥åº¦**: ğŸ”´ğŸ”´ğŸ”´ æé«˜  
**éš¾åº¦**: ğŸŸ¡ ä¸­ç­‰  
**é¢„ä¼°æ—¶é—´**: 2-3 å¤©  
**æœªæ¥æ”¶ç›Š**: èŠ‚çœ 2-3 å‘¨é‡æ„æ—¶é—´

---

## ğŸ”´ è¦ç´  2ï¼šAPI è®¾è®¡æ¨¡å¼

### ä¸ºä»€ä¹ˆæ˜¯é«˜ä¼˜å…ˆçº§ï¼Ÿ

**åŸå› åˆ†æ**ï¼š
1. **æ¶æ„åŸºç¡€**ï¼šAPI è®¾è®¡å†³å®šå‰åç«¯çš„è€¦åˆåº¦
2. **å¹³å°è¿ç§»**ï¼šä» Cloudflare Workers åˆ° Next.js API Routes
3. **å¯ç»´æŠ¤æ€§**ï¼šè‰¯å¥½çš„ API è®¾è®¡ä¾¿äºæµ‹è¯•å’Œæ‰©å±•
4. **MkSaaS æ ‡å‡†**ï¼šéµå¾ª MkSaaS çš„ RESTful é£æ ¼

**MkSaaS API ç‰¹ç‚¹**ï¼š
- ä½¿ç”¨ **Next.js API Routes**
- **RESTful** é£æ ¼
- ç»Ÿä¸€çš„**è¯·æ±‚/å“åº”æ ¼å¼**
- å®Œå–„çš„**é”™è¯¯å¤„ç†**
- **ç±»å‹å®‰å…¨**ï¼ˆTypeScriptï¼‰

### è®¾è®¡åŸåˆ™

#### åŸåˆ™ 1ï¼šåˆ†å±‚æ¶æ„ï¼ˆå…³é”®ï¼ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Routes Layer (å¹³å°ç›¸å…³)              â”‚
â”‚  - Cloudflare Workers (ç°åœ¨)         â”‚
â”‚  - Next.js API Routes (æœªæ¥)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†•ï¸
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Service Layer (å¹³å°æ— å…³)             â”‚
â”‚  - çº¯ä¸šåŠ¡é€»è¾‘                         â”‚
â”‚  - å¯åœ¨ä»»ä½•å¹³å°è¿è¡Œ                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†•ï¸
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Data Layer (æ•°æ®è®¿é—®)                â”‚
â”‚  - Drizzle ORM                       â”‚
â”‚  - æ•°æ®åº“æ“ä½œ                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç›®å½•ç»“æ„**ï¼š

```
src/
â”œâ”€â”€ routes/                    # è·¯ç”±å±‚ï¼ˆå¹³å°ç›¸å…³ï¼‰
â”‚   â”œâ”€â”€ cloudflare/           # Cloudflare Workers é€‚é…å™¨
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â””â”€â”€ nextjs/               # Next.js é€‚é…å™¨ï¼ˆæœªæ¥ç”¨ï¼‰
â”‚       â””â”€â”€ route.ts
â”‚
â”œâ”€â”€ services/                  # æœåŠ¡å±‚ï¼ˆå¹³å°æ— å…³ï¼‰
â”‚   â”œâ”€â”€ image-service.ts      # å›¾åƒå¤„ç†æœåŠ¡
â”‚   â”œâ”€â”€ ai-service.ts         # AI è°ƒç”¨æœåŠ¡
â”‚   â””â”€â”€ storage-service.ts    # å­˜å‚¨æœåŠ¡
â”‚
â”œâ”€â”€ lib/                       # å·¥å…·åº“
â”‚   â”œâ”€â”€ db.ts                 # æ•°æ®åº“è¿æ¥
â”‚   â””â”€â”€ utils.ts              # å·¥å…·å‡½æ•°
â”‚
â””â”€â”€ types/                     # ç±»å‹å®šä¹‰
    â””â”€â”€ api.ts                # API ç±»å‹
```

#### åŸåˆ™ 2ï¼šRESTful é£æ ¼

```typescript
// âŒ é”™è¯¯è®¾è®¡ï¼ˆä¸è§„èŒƒçš„è·¯ç”±ï¼‰
POST /generateImage
GET /getImages
POST /deleteImage

// âœ… æ­£ç¡®è®¾è®¡ï¼ˆRESTfulï¼‰
POST   /api/images/generate    # ç”Ÿæˆå›¾åƒ
GET    /api/images             # è·å–å›¾åƒåˆ—è¡¨
GET    /api/images/:id         # è·å–å•ä¸ªå›¾åƒ
DELETE /api/images/:id         # åˆ é™¤å›¾åƒ
PATCH  /api/images/:id         # æ›´æ–°å›¾åƒ

POST   /api/images/chat        # AI èŠå¤©ç”Ÿæˆ
POST   /api/images/video       # è§†é¢‘ç”Ÿæˆ
```

**è·¯ç”±å‘½åè§„èŒƒ**ï¼š
- ä½¿ç”¨å¤æ•°åè¯ï¼ˆ`/images` è€Œé `/image`ï¼‰
- ä½¿ç”¨ HTTP åŠ¨è¯è¡¨ç¤ºæ“ä½œ
- åµŒå¥—èµ„æºä½¿ç”¨ `/` åˆ†éš”
- ä½¿ç”¨ kebab-caseï¼ˆ`/user-preferences`ï¼‰

#### åŸåˆ™ 3ï¼šç»Ÿä¸€çš„è¯·æ±‚/å“åº”æ ¼å¼

```typescript
// types/api.ts

// ç»Ÿä¸€çš„ API å“åº”æ ¼å¼
export interface ApiResponse<T = any> {
  success: boolean;
  data?: T;
  error?: {
    code: string;
    message: string;
    details?: any;
  };
  metadata?: {
    timestamp: string;
    requestId: string;
    version: string;
  };
}

// åˆ†é¡µå“åº”
export interface PaginatedResponse<T> extends ApiResponse<T[]> {
  pagination: {
    page: number;
    limit: number;
    total: number;
    totalPages: number;
  };
}

// ä½¿ç”¨ç¤ºä¾‹
const response: ApiResponse<Asset> = {
  success: true,
  data: {
    id: '123',
    url: 'https://...',
    // ...
  },
  metadata: {
    timestamp: new Date().toISOString(),
    requestId: crypto.randomUUID(),
    version: '1.0'
  }
};
```

### å®ç°ç¤ºä¾‹

#### Cloudflare Workers å®ç°ï¼ˆç°åœ¨ï¼‰

```typescript
// routes/cloudflare/index.ts
import { imageService } from '@/services/image-service';
import type { ApiResponse } from '@/types/api';

export default {
  async fetch(request: Request, env: Env): Promise<Response> {
    const url = new URL(request.url);
    const path = url.pathname;
    
    // è·¯ç”±åˆ†å‘
    if (path === '/api/images/generate' && request.method === 'POST') {
      return handleGenerateImage(request, env);
    }
    
    if (path === '/api/images' && request.method === 'GET') {
      return handleGetImages(request, env);
    }
    
    return jsonResponse({ success: false, error: { code: 'NOT_FOUND', message: 'Route not found' } }, 404);
  }
};

// å¤„ç†å‡½æ•°ï¼ˆè°ƒç”¨ service å±‚ï¼‰
async function handleGenerateImage(request: Request, env: Env): Promise<Response> {
  try {
    const body = await request.json();
    
    // è°ƒç”¨æœåŠ¡å±‚ï¼ˆå¹³å°æ— å…³ï¼‰
    const result = await imageService.generate({
      prompt: body.prompt,
      effect: body.effect,
      userId: body.userId || 'anonymous',  // ç°åœ¨ç”¨é»˜è®¤å€¼
    });
    
    return jsonResponse<Asset>({
      success: true,
      data: result,
    });
    
  } catch (error) {
    return jsonResponse({
      success: false,
      error: {
        code: 'GENERATION_FAILED',
        message: error.message,
      }
    }, 500);
  }
}

// è¾…åŠ©å‡½æ•°
function jsonResponse<T>(data: ApiResponse<T>, status: number = 200): Response {
  return new Response(JSON.stringify(data), {
    status,
    headers: { 'Content-Type': 'application/json' }
  });
}
```

#### Next.js API Routes å®ç°ï¼ˆæœªæ¥ï¼‰

```typescript
// app/api/images/generate/route.ts
import { imageService } from '@/services/image-service';
import { auth } from '@/lib/auth';
import type { ApiResponse } from '@/types/api';

export async function POST(req: Request) {
  try {
    // è®¤è¯ï¼ˆæœªæ¥æ·»åŠ ï¼‰
    const session = await auth.api.getSession({ headers: req.headers });
    if (!session) {
      return Response.json<ApiResponse>({
        success: false,
        error: { code: 'UNAUTHORIZED', message: 'Authentication required' }
      }, { status: 401 });
    }
    
    const body = await req.json();
    
    // è°ƒç”¨ç›¸åŒçš„æœåŠ¡å±‚ï¼ˆæ— éœ€ä¿®æ”¹ï¼‰
    const result = await imageService.generate({
      prompt: body.prompt,
      effect: body.effect,
      userId: session.user.id,  // ä½¿ç”¨çœŸå® userId
    });
    
    return Response.json<ApiResponse<Asset>>({
      success: true,
      data: result,
    });
    
  } catch (error) {
    return Response.json<ApiResponse>({
      success: false,
      error: {
        code: 'GENERATION_FAILED',
        message: error.message,
      }
    }, { status: 500 });
  }
}
```

#### æœåŠ¡å±‚å®ç°ï¼ˆå¹³å°æ— å…³ï¼‰

```typescript
// services/image-service.ts
import { db } from '@/lib/db';
import { assets } from '@/db/schema';
import { aiService } from './ai-service';
import { storageService } from './storage-service';

export interface GenerateImageParams {
  prompt: string;
  effect?: string;
  userId: string;
  images?: string[];
  mask?: string;
}

export const imageService = {
  async generate(params: GenerateImageParams): Promise<Asset> {
    // 1. è°ƒç”¨ AI æœåŠ¡ç”Ÿæˆå›¾åƒ
    const imageData = await aiService.generateImage({
      prompt: params.prompt,
      effect: params.effect,
    });
    
    // 2. ä¸Šä¼ åˆ°å­˜å‚¨
    const url = await storageService.upload({
      data: imageData,
      path: `users/${params.userId}/assets/${crypto.randomUUID()}.png`,
    });
    
    // 3. ä¿å­˜åˆ°æ•°æ®åº“
    const [asset] = await db.insert(assets).values({
      userId: params.userId,
      type: 'image',
      url,
      prompt: params.prompt,
      effect: params.effect,
      metadata: {
        generationTime: Date.now(),
        aiModel: 'gemini-2.5-flash-image',
      },
    }).returning();
    
    return asset;
  },
  
  async getAssets(userId: string, page: number = 1, limit: number = 20) {
    const offset = (page - 1) * limit;
    
    const items = await db.select()
      .from(assets)
      .where(eq(assets.userId, userId))
      .orderBy(desc(assets.createdAt))
      .limit(limit)
      .offset(offset);
    
    const [{ count }] = await db.select({ count: count() })
      .from(assets)
      .where(eq(assets.userId, userId));
    
    return {
      items,
      pagination: {
        page,
        limit,
        total: count,
        totalPages: Math.ceil(count / limit),
      },
    };
  },
};
```

### å®æ–½æ£€æŸ¥æ¸…å•

- [ ] é‡‡ç”¨åˆ†å±‚æ¶æ„ï¼ˆroutes â†’ services â†’ dataï¼‰
- [ ] ä½¿ç”¨ RESTful é£æ ¼çš„è·¯ç”±
- [ ] ç»Ÿä¸€çš„è¯·æ±‚/å“åº”æ ¼å¼
- [ ] æœåŠ¡å±‚ä¸å¹³å°è§£è€¦
- [ ] å®Œå–„çš„é”™è¯¯å¤„ç†
- [ ] TypeScript ç±»å‹å®šä¹‰
- [ ] API æ–‡æ¡£ï¼ˆå¯é€‰ï¼šä½¿ç”¨ OpenAPI/Swaggerï¼‰

**ç´§æ€¥åº¦**: ğŸ”´ğŸ”´ é«˜  
**éš¾åº¦**: ğŸŸ¡ ä¸­ç­‰  
**é¢„ä¼°æ—¶é—´**: 1-2 å¤©  
**æœªæ¥æ”¶ç›Š**: èŠ‚çœ 1-2 å‘¨é‡æ„æ—¶é—´

---

## ğŸŸ¡ è¦ç´  3ï¼šç¯å¢ƒå˜é‡ç®¡ç†

### ä¸ºä»€ä¹ˆé‡è¦ï¼Ÿ

**åŸå› åˆ†æ**ï¼š
1. **æ ‡å‡†åŒ–**ï¼šMkSaaS æœ‰å›ºå®šçš„ç¯å¢ƒå˜é‡å‘½åè§„èŒƒ
2. **å®‰å…¨æ€§**ï¼šæ•æ„Ÿä¿¡æ¯ï¼ˆAPI Keyï¼‰çš„ç®¡ç†
3. **å¯ç§»æ¤æ€§**ï¼šä¸åŒç¯å¢ƒï¼ˆå¼€å‘/ç”Ÿäº§ï¼‰çš„é…ç½®
4. **é›¶æˆæœ¬è¿ç§»**ï¼šç°åœ¨éµå¾ªæ ‡å‡†ï¼Œæœªæ¥ç›´æ¥ä½¿ç”¨

### è®¾è®¡åŸåˆ™

#### åŸåˆ™ 1ï¼šéµå¾ª MkSaaS å‘½åè§„èŒƒ

```bash
# .env.example

# ============================================
# æ•°æ®åº“é…ç½®
# ============================================
DATABASE_URL=postgresql://user:password@host:5432/dbname

# ============================================
# AI æœåŠ¡é…ç½®ï¼ˆç°åœ¨éœ€è¦ï¼‰
# ============================================
GEMINI_API_KEY=your_gemini_api_key_here
OPENAI_API_KEY=your_openai_api_key_here  # å¯é€‰

# ============================================
# æ–‡ä»¶å­˜å‚¨é…ç½®
# ============================================
# Cloudflare R2
R2_ACCOUNT_ID=your_account_id
R2_ACCESS_KEY_ID=your_access_key
R2_SECRET_ACCESS_KEY=your_secret_key
R2_BUCKET_NAME=your_bucket_name
R2_PUBLIC_URL=https://your-bucket.r2.dev

# ============================================
# åº”ç”¨é…ç½®
# ============================================
NEXT_PUBLIC_APP_URL=http://localhost:3000
NEXT_PUBLIC_APP_NAME="Your App Name"

# ============================================
# è®¤è¯é…ç½®ï¼ˆæœªæ¥éœ€è¦ï¼Œç°åœ¨å¯ä»¥ç•™ç©ºï¼‰
# ============================================
# BETTER_AUTH_SECRET=
# BETTER_AUTH_URL=
# GOOGLE_CLIENT_ID=
# GOOGLE_CLIENT_SECRET=

# ============================================
# æ”¯ä»˜é…ç½®ï¼ˆæœªæ¥éœ€è¦ï¼‰
# ============================================
# STRIPE_SECRET_KEY=
# STRIPE_PUBLISHABLE_KEY=
# STRIPE_WEBHOOK_SECRET=

# ============================================
# é‚®ä»¶é…ç½®ï¼ˆæœªæ¥éœ€è¦ï¼‰
# ============================================
# RESEND_API_KEY=

# ============================================
# åˆ†æé…ç½®ï¼ˆå¯é€‰ï¼‰
# ============================================
# NEXT_PUBLIC_GA_ID=
# NEXT_PUBLIC_UMAMI_ID=
```

#### åŸåˆ™ 2ï¼šç±»å‹å®‰å…¨çš„ç¯å¢ƒå˜é‡

```typescript
// config/env.ts
import { z } from 'zod';

// å®šä¹‰ç¯å¢ƒå˜é‡ schema
const envSchema = z.object({
  // æ•°æ®åº“
  DATABASE_URL: z.string().url(),
  
  // AI æœåŠ¡
  GEMINI_API_KEY: z.string().min(1),
  OPENAI_API_KEY: z.string().optional(),
  
  // å­˜å‚¨
  R2_ACCOUNT_ID: z.string().min(1),
  R2_ACCESS_KEY_ID: z.string().min(1),
  R2_SECRET_ACCESS_KEY: z.string().min(1),
  R2_BUCKET_NAME: z.string().min(1),
  R2_PUBLIC_URL: z.string().url(),
  
  // åº”ç”¨
  NEXT_PUBLIC_APP_URL: z.string().url(),
  NEXT_PUBLIC_APP_NAME: z.string().default('My App'),
  
  // æœªæ¥çš„é…ç½®ï¼ˆoptionalï¼‰
  BETTER_AUTH_SECRET: z.string().optional(),
  STRIPE_SECRET_KEY: z.string().optional(),
  RESEND_API_KEY: z.string().optional(),
});

// éªŒè¯å¹¶å¯¼å‡º
export const env = envSchema.parse(process.env);

// TypeScript ç±»å‹æ¨å¯¼
export type Env = z.infer<typeof envSchema>;
```

**ä½¿ç”¨æ–¹å¼**ï¼š

```typescript
// âœ… ç±»å‹å®‰å…¨
import { env } from '@/config/env';

const apiKey = env.GEMINI_API_KEY;  // string
const appUrl = env.NEXT_PUBLIC_APP_URL;  // string

// âŒ ç¼–è¯‘é”™è¯¯
const invalid = env.INVALID_KEY;  // TypeScript æŠ¥é”™
```

### å®æ–½æ£€æŸ¥æ¸…å•

- [ ] åˆ›å»º `.env.example` æ¨¡æ¿
- [ ] éµå¾ª MkSaaS å‘½åè§„èŒƒ
- [ ] ä½¿ç”¨ Zod è¿›è¡Œç±»å‹éªŒè¯
- [ ] åŒºåˆ†å…¬å¼€å˜é‡ï¼ˆ`NEXT_PUBLIC_`ï¼‰å’Œç§å¯†å˜é‡
- [ ] æ·»åŠ æ³¨é‡Šè¯´æ˜æ¯ä¸ªå˜é‡çš„ç”¨é€”
- [ ] åœ¨ `.gitignore` ä¸­æ’é™¤ `.env.local`
- [ ] æ–‡æ¡£åŒ–ç¯å¢ƒå˜é‡é…ç½®æµç¨‹

**ç´§æ€¥åº¦**: ğŸŸ¡ ä¸­  
**éš¾åº¦**: ğŸŸ¢ ä½  
**é¢„ä¼°æ—¶é—´**: 2-4 å°æ—¶  
**æœªæ¥æ”¶ç›Š**: èŠ‚çœ 2-3 å¤©

---

ç”±äºæ–‡æ¡£è¾ƒé•¿ï¼Œæˆ‘å°†ç»§ç»­åœ¨ä¸‹ä¸€éƒ¨åˆ†å®Œæˆå‰©ä½™çš„ 10 ä¸ªè¦ç´ ...
