好的，这是对您提供的最后一个文档“支付”的完整 Markdown 格式转换。所有内容，包括标题、文本、代码块、结构，以及对所有图片的识别和描述，都已包含在内。至此，您提供的所有文档都已转换完毕。

***

### 文件 16：支付 (Payments)

<+> MkSaaS 文档
Π
Q 搜索文档
*   **主页**
*   **介绍**
*   <> 代码库
*   **视频教程**
*   **入门**
*   <> 环境设置
*   **配置**
    *   网站配置
    *   导航栏菜单
    *   页脚菜单
    *   侧边栏菜单
    *   头像按钮
    *   社交媒体
    *   价格计划
    *   信用套餐
*   **部署**
*   **集成**
    *   数据库
    *   验证
    *   电子邮件
    *   通讯
    *   贮存
    *   **日支付**
    *   致谢
    *   ① 计划任务
    *   人工智能
    *   分析
    *   通知
    *   ○ 验证码
    *   聊天框
    *   关联公司
*   **定制**
    *   目元数据
    *   T字体
    *   主题
    *   图片
    *   国际化
    *   博客
    *   文档
*   **成分**
    *   ● 自定义页面
    *   登陆页面
    *   用户管理
*   **代码库**
    *   IDE 设置
    *   品项目结构
    *   A格式化和 Linting
    *   更新代码库

---

### 支付

了解如何设置和使用 Stripe 处理付款和订阅。

MkSaaS 使用 **Stripe** 进行支付管理，并以灵活且开发人员友好的方式处理一次性付款和定期订阅。

#### 设置

MkSaaS 样板默认使用三种价格计划：免费计划、专业订阅计划（按月/按年）和终身计划（一次性付款），请按照以下步骤设置 Stripe 集成：

1.  在 `stripe.com` 上创建 Stripe 帐户。
2.  从 Stripe 仪表板获取您的 API 密钥：
    *   前往 **Stripe 控制面板 > Developers > API keys**。
    *   复制您的密钥（注意：测试模式以 `sk_test_` 开头，实时模式以 `sk_live_` 开头）。
    *   将其作为 `STRIPE_SECRET_KEY` 保存到您的 `.env` 文件中。
3.  设置 Webhook 并获取您的 Webhook Secret：
    *   前往 **Stripe 仪表板 > Developers > Webhooks**。
    *   单击 **Add endpoint**。
    *   输入 Webhook URL: `https://your-domain.com/api/webhooks/stripe`。
    *   选择要监听的事件：
        *   `invoice.paid`
        *   `checkout.session.completed`
        *   `customer.subscription.created`
        *   `customer.subscription.updated`
        *   `customer.subscription.deleted`
    *   单击 **Reveal** 以查看 Webhook 签名密钥（以 `whsec_` 开头）。
    *   将其保存到您的 `.env` 文件中，作为 `STRIPE_WEBHOOK_SECRET`。
    > ● 如果您想在开发环境中测试付款，您可以在 **Webhooks** 部分找到更多信息。
4.  在 Stripe 中创建产品和定价计划：
    *   前往 **Stripe 控制面板 > Product Catalog**。
    *   **创建 Pro 订阅产品**：
        *   点击 **Add product**。
        *   **名称**: `Pro Plan`。
        *   **描述**: `Advanced features with subscription pricing`。
    *   **添加月费**：
        *   点击 **Add price**。
        *   **价格**: `9.90 美元`（货币选择美元）。
        *   **重复**: `每月`。
        *   保存并复制价格 ID（以 `price_` 开头），这将用于 `NEXT_PUBLIC_STRIPE_PRICE_PRO_MONTHLY`。
    *   **添加年费**：
        *   点击 **Add price**。
        *   **价格**: `99.00 美元`（货币选择美元）。
        *   **重复**: `每年`。
        *   保存并复制价格 ID（以 `price_` 开头），这将用于 `NEXT_PUBLIC_STRIPE_PRICE_PRO_YEARLY`。
    *   **创建终身产品**：
        *   点击 **Add product**。
        *   **名称**: `Lifetime Plan`。
        *   **描述**: `One-time payment for lifetime access`。
    *   **添加价格**：
        *   **价格**: `199.00 美元`（货币选择美元）。
        *   **类型**: `一次性`。
        *   保存并复制价格 ID（以 `price_` 开头），这将用于 `NEXT_PUBLIC_STRIPE_PRICE_LIFETIME`。
    ![图片描述：Stripe 产品目录截图，显示了一个名为“PRO”的有效产品，并列出了其月度和年度价格。](https://storage.googleapis.com/agent-tools-public-mde/1723152014603-1.png)
5.  添加以下环境变量：
    `.env`
    ```env
    STRIPE_SECRET_KEY=sk_test_...
    STRIPE_WEBHOOK_SECRET=whsec_...

    # Price plans
    NEXT_PUBLIC_STRIPE_PRICE_PRO_MONTHLY=price_...
    NEXT_PUBLIC_STRIPE_PRICE_PRO_YEARLY=price_...
    NEXT_PUBLIC_STRIPE_PRICE_LIFETIME=price_...
    ```
6.  设置 Stripe 客户门户：
    *   前往 **Stripe 控制面板 > Settings > Billing > Customer Portal**。
    *   自定义客户门户的内容，例如，您可以添加自定义徽标和标题。
    *   单击 **Save changes** 以保存门户配置。
    ![图片描述：Stripe 客户门户设置页面截图，展示了如何配置客户管理订阅、支付账单和更新支付信息的门户界面。](https://storage.googleapis.com/agent-tools-public-mde/1723152014603-2.png)
7.  更新 `website.tsx` 文件以在付款配置中使用 Stripe 作为付款提供商，并在价格配置中配置您的定价计划：
    `src/config/website.tsx`
    ```tsx
    lifetime: {
      id: 'lifetime',
      prices: [
        {
          type: PaymentTypes.ONE_TIME,
          priceId: process.env.NEXT_PUBLIC_STRIPE_PRICE_LIFETIME!,
          amount: 19900,
          currency: 'USD',
          allowPromotionCode: true,
        },
      ],
      isFree: false,
      isLifetime: true,
      credits: {
        enable: true,
        amount: 1000,
        expireDays: 30,
      },
    },
    // ...other config
    ```
> ▲ 如果您正在设置环境，现在可以返回**环境设置指南**并继续。本指南的其余部分可以稍后阅读。
>
> **<> 环境设置**
> 设置环境变量

#### 支付系统结构

MkSaaS 的支付系统设计有以下组件：

*   `源码 (src)`
    *   `支付 (payment)`
        *   `提供者 (provider)`
        *   `索引.ts`
        *   `类型.ts`
        *   `自述文件.md`
    *   `行动 (actions)`
    *   `应用程序 (app)`
    *   `成分 (components)`

这种模块化结构使得使用新的提供商、定价计划和 UI 组件来扩展支付系统变得容易。

#### 核心功能

*   一次性付款，终身访问
*   定期订阅付款（每月/每年）
*   用于订阅管理的客户门户集成
*   支付事件的 Webhook 处理
*   订阅状态跟踪和验证
*   内置定价组件（表格、卡片、按钮）
*   安全支付操作的服务器操作
*   用于支付状态管理的 React Hooks
*   支持多种定价计划（免费、专业、终身）

#### 用法

MkSaaS 提供简单的支付实用程序来处理结帐会话和客户门户：
```ts
import { createCheckout, createCustomerPortal } from '@/payment';

// Create a checkout session
const checkoutResult = await createCheckout({
  planId: 'pro',
  priceId: process.env.NEXT_PUBLIC_STRIPE_PRICE_PRO_MONTHLY!,
  customerEmail: 'user@example.com',
  successUrl: 'https://example.com/payment/success',
  cancelUrl: 'https://example.com/payment/cancel',
  metadata: { userId: 'user_123' },
});

// Redirect to checkout URL
window.location.href = checkoutResult.url;

// Create a customer portal session
const portalResult = await createCustomerPortal({
  customerId: 'cus_123',
  returnUrl: 'https://example.com/account/billing',
});

// Redirect to portal URL
window.location.href = portalResult.url;
```

#### Webhook

Stripe Webhooks 对于处理异步事件（如成功付款和订阅更新）至关重要。

##### 发展

对于本地开发，您可以使用 Stripe CLI 将事件转发到本地服务器：
```bash
# 安装 Stripe CLI
pnpm install -g stripe/stripe-cli

# 登录 Stripe
stripe login

# 将事件转发到本地服务器
stripe listen --forward-to localhost:3000/api/webhooks/stripe
```
Webhook 密钥会打印在终端中。复制它并将其添加到你的 `.env` 文件中：
`STRIPE_WEBHOOK_SECRET=whsec_...`

您可以使用 Stripe CLI 触发测试事件，或者在网站上测试事件：
`stripe trigger invoice.paid`

##### 生产

1.  前往 **Stripe 仪表板 > 开发者 > Webhooks**。
2.  单击 **Add endpoint**。
3.  输入 Webhook URL: `https://your-domain.com/api/webhooks/stripe`。
4.  选择要监听的事件：
    *   `invoice.paid`
    *   `checkout.session.completed`
    *   `customer.subscription.created`
    *   `customer.subscription.updated`
    *   `customer.subscription.deleted`
5.  创建后，单击 **Reveal** 即可查看您的 Webhook 签名密钥。
6.  复制 Webhook 密钥（以 `whsec_` 开头）并将其添加到您的环境变量中。

#### UI 组件

MkSaaS 包括用于处理付款的预构建 React 组件：

*   创建结帐按钮
*   客户门户按钮
*   价格表
*   定价卡

#### Webhook 事件

支付系统在 `handleWebhookEvent` 方法中处理这些 Webhook 事件：

`src/付款/提供商/stripe.ts`
```ts
public async handleWebhookEvent(payload: string, signature: string): Promise<void> {
  // Implementation to handle various Stripe webhook events:
  // - checkout.session.completed
  // - customer.subscription.created
  // - customer.subscription.updated
  // - customer.subscription.deleted
  // - invoice.paid
}
```

#### 定制

##### 创建新的支付提供商

MkSaaS 可以轻松地通过新的提供商扩展支付系统：

1.  在 `src/payment/provider` 目录中创建一个新文件。
2.  从 `types.ts` 实现 `PaymentProvider` 接口。
3.  更新 `index.ts` 中的支付提供商选择逻辑。

新提供商的示例实现：

`src/付款/提供商/my-provider.ts`
```ts
import {
  PaymentProvider,
  CreateCheckoutParams,
  // ... other imports
} from '@/payment/types';

export class MyProvider implements PaymentProvider {
  constructor() {
    // Initialize your payment provider
  }

  public async createCheckout(params: CreateCheckoutParams): Promise<CheckoutResult> {
    // Implementation for creating a checkout session
  }

  public async createCustomerPortal(params: CreatePortalParams): Promise<PortalResult> {
    // Implementation for creating a customer portal
  }
  
  public async handleWebhookEvent(payload: string, signature: string): Promise<void> {
    // Implementation for handling webhook events
  }
}
```
然后在 `index.ts` 中更新支付提供商选择：

`src/付款/index.ts`
```ts
import { MyProvider } from './provider/my-provider';

export const initializePaymentProvider = (): PaymentProvider => {
  if (!paymentProvider) {
    if (websiteConfig.payment.provider === 'stripe') {
      paymentProvider = new StripeProvider();
    } else if (websiteConfig.payment.provider === 'my-provider') {
      paymentProvider = new MyProvider();
    } else {
      throw new Error(
        `Unsupported payment provider: ${websiteConfig.payment.provider}`
      );
    }
  }
  return paymentProvider;
};
```

#### 测试卡

要测试 Stripe 集成，请使用 Stripe 的测试模式并测试信用卡：

*   `4242 4242 4242 4242` - 付款成功
*   `4000 0000 0000 3220` - 需要 3D 安全认证
*   `4000 0000 0000 9995` - 资金不足故障

您可以在 Stripe 文档中找到有关 [Stripe 测试卡](https://stripe.com/docs/testing)的更多信息。

#### 发票

MkSaaS 已经配置了一次性付款的发票创建。

`src/付款/提供商/stripe.ts`
```ts
// Automatically create an invoice for the one-time payment
checkoutParams.invoice_creation = {
  enabled: true,
};
```
如果您想自动发送已付款发票，您可以在 **Customer emails settings** 中启用此功能，在 **Email customers about** 下，选择 **Successful payments**。之后，您可以在 **Stripe 控制面板 > Invoices** 中访问发票。

![图片描述：Stripe 客户电子邮件设置截图，显示了启用“Successful payments”通知的选项。](https://storage.googleapis.com/agent-tools-public-mde/1723152014603-5.png)

您可以在 Stripe 文档中找到有关[自动发送已付发票](https://stripe.com/docs/billing/invoices/email)的更多信息。

#### 图表

这是支付流程图，您可以观看视频教程了解更多详情。

![图片描述：一个详细的支付流程时序图，展示了从用户在定价页面点击按钮开始，到创建结账会话、重定向到 Stripe、处理付款、更新用户数据库、最后重定向到确认页面的完整流程。](https://storage.googleapis.com/agent-tools-public-mde/1723152014603-6.png)

#### 常问问题

##### 如何开通微信支付和支付宝？

您可以在 **Stripe 控制面板 > Settings > Payment methods** 中激活微信支付和支付宝。您可以在 Stripe 文档中找到有关微信支付和支付宝的更多信息。

![图片描述：Stripe 支付方式设置页面截图，列出了多种支付方式如银行卡、支付宝、Apple Pay、Google Pay 等，并显示了它们的状态（Active 或 Pending）。](https://storage.googleapis.com/agent-tools-public-mde/1723152014603-7.png)

##### 如何限制用户只能订阅一个？

您可以在 **Stripe 控制面板 > Settings > Checkout and Payment Links > Subscriptions** 中启用 **Limit customers to 1 subscription**。您可以在 Stripe 文档中找到有关将客户限制为一个订阅的更多信息。

![图片描述：Stripe 订阅设置页面截图，显示了“Limit customers to 1 subscription”的开关选项，用于限制客户只能拥有一个有效的订阅。](https://storage.googleapis.com/agent-tools-public-mde/1723152014603-8.png)

#### 最佳实践

1.  **安全 API 密钥**：切勿在客户端代码中暴露您的 Stripe 密钥。
2.  **验证 Webhook 签名**：始终验证 Webhook 事件的签名。
3.  **优雅地处理错误**：付款失败时提供用户友好的错误消息。
4.  **彻底测试 Webhook**：确保所有 Webhook 事件都得到正确处理。

#### 视频教程

<br>
![图片描述：一个视频教程的缩略图，标题为“MkSaaS模板 配置和部署教程”，副标题为“从拉取代码到部署上线的全流程实录”。画面中有一个火箭图标，象征着部署和启动。](https://storage.googleapis.com/agent-tools-public-mde/1723149495094-2.png)
> [在 YouTube 上观看：MkSaaS模板的网站配置和部署教程](https://www.youtube.com/watch?v=placeholder)
<br>
![图片描述：一个视频教程的缩略图，标题为“MkSaaS模板 支付模块的方案和流程”，副标题为“介绍支付模块的技术实现方案和完整支付流程”。画面中有一叠美元钞票的图标。](https://storage.googleapis.com/agent-tools-public-mde/1723152014603-9.png)
> [在 YouTube 上观看：MkSaaS模板的支付模块的方案和流程](https://www.youtube.com/watch?v=placeholder)
<br>

#### 参考

*   [Stripe 文档](https://stripe.com/docs)
*   [Stripe 支付对象概览](https://stripe.com/docs/api/payment_intents)
*   [Stripe 最佳实践](https://stripe.com/docs/best-practices)

#### 后续步骤

现在您已经了解了如何在 MkSaaS 中处理付款，请探索以下相关集成：

| | |
| :--- | :--- |
| **Θ 价格配置**<br>配置订阅计划和定价 | **验证**<br>配置用户身份验证 |
| **ال 分析**<br>配置分析 | **☑ 电子邮件设置**<br>配置电子邮件服务 |

< **贮存**
了解如何设置和使用云存储进行文件上传和媒体处理

**致谢 >**
了解如何在应用程序中设置和使用积分系统