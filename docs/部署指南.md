# 🚀 部署指南

本文档详细介绍如何将香蕉PS乐园部署到各种平台。

## 📋 部署前准备

### 1. 构建生产版本

```bash
# 安装依赖
npm install

# 构建生产版本
npm run build
```

构建完成后，会在项目根目录生成 `dist` 文件夹，包含所有静态文件。

### 2. 本地预览

```bash
# 预览生产版本
npm run preview
```

访问 http://localhost:4173 查看生产版本效果。

### 3. 环境变量配置

确保在部署平台配置以下环境变量：

```env
GEMINI_API_KEY=你的API密钥
```

> ⚠️ **重要**：不要将 API 密钥提交到代码仓库！

---

## 🌐 Vercel 部署（推荐）

Vercel 是最简单的部署方式，支持自动部署和 HTTPS。

### 方法 1：通过 GitHub 自动部署

1. **连接 GitHub 仓库**
   - 访问 [Vercel](https://vercel.com/)
   - 点击 "New Project"
   - 选择你的 GitHub 仓库
   - 授权 Vercel 访问

2. **配置项目**
   - Framework Preset: Vite
   - Root Directory: `./`
   - Build Command: `npm run build`
   - Output Directory: `dist`

3. **配置环境变量**
   - 在 "Environment Variables" 部分添加：
     - Name: `GEMINI_API_KEY`
     - Value: 你的 API 密钥
     - Environment: Production

4. **部署**
   - 点击 "Deploy"
   - 等待构建完成（通常 1-2 分钟）
   - 获得部署 URL（如 `your-app.vercel.app`）

5. **自动部署**
   - 每次推送到 GitHub 主分支时自动部署
   - Pull Request 会生成预览部署

### 方法 2：通过 Vercel CLI 部署

```bash
# 安装 Vercel CLI
npm install -g vercel

# 登录
vercel login

# 部署
vercel

# 部署到生产环境
vercel --prod
```

### 自定义域名

1. 在 Vercel 项目设置中点击 "Domains"
2. 添加你的域名
3. 按照提示配置 DNS 记录
4. 等待 DNS 生效（通常几分钟到几小时）

---

## 🔷 Netlify 部署

Netlify 也是一个优秀的静态网站托管平台。

### 方法 1：拖拽部署

1. **构建项目**
   ```bash
   npm run build
   ```

2. **上传到 Netlify**
   - 访问 [Netlify](https://www.netlify.com/)
   - 点击 "Add new site" → "Deploy manually"
   - 拖拽 `dist` 文件夹到上传区域
   - 等待部署完成

3. **配置环境变量**
   - 进入 Site settings → Environment variables
   - 添加 `GEMINI_API_KEY`

### 方法 2：通过 GitHub 自动部署

1. **连接 GitHub**
   - 点击 "Add new site" → "Import an existing project"
   - 选择 GitHub 并授权
   - 选择你的仓库

2. **配置构建设置**
   - Build command: `npm run build`
   - Publish directory: `dist`
   - 添加环境变量 `GEMINI_API_KEY`

3. **部署**
   - 点击 "Deploy site"
   - 每次推送到主分支自动部署

### 方法 3：通过 Netlify CLI 部署

```bash
# 安装 Netlify CLI
npm install -g netlify-cli

# 登录
netlify login

# 初始化
netlify init

# 部署
netlify deploy

# 部署到生产环境
netlify deploy --prod
```

---

## 📄 GitHub Pages 部署

GitHub Pages 提供免费的静态网站托管。

### 配置步骤

1. **修改 vite.config.ts**

```typescript
// vite.config.ts
export default defineConfig({
  base: '/nano-bananary-playground/',  // 你的仓库名
  // ... 其他配置
});
```

2. **构建项目**

```bash
npm run build
```

3. **部署到 gh-pages 分支**

```bash
# 安装 gh-pages
npm install -D gh-pages

# 添加部署脚本到 package.json
{
  "scripts": {
    "deploy": "gh-pages -d dist"
  }
}

# 部署
npm run deploy
```

4. **配置 GitHub Pages**
   - 进入仓库 Settings → Pages
   - Source: Deploy from a branch
   - Branch: gh-pages / (root)
   - 点击 Save

5. **访问网站**
   - URL: `https://你的用户名.github.io/仓库名/`

### 注意事项

- GitHub Pages 不支持环境变量
- 需要在客户端硬编码 API 密钥（不推荐）
- 或者使用后端代理（推荐）

---

## 🐳 Docker 部署

使用 Docker 可以在任何支持 Docker 的平台部署。

### 创建 Dockerfile

```dockerfile
# Dockerfile
FROM node:18-alpine AS builder

WORKDIR /app

COPY package*.json ./
RUN npm ci

COPY . .
RUN npm run build

FROM nginx:alpine

COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
```

### 创建 nginx.conf

```nginx
# nginx.conf
server {
    listen 80;
    server_name _;
    root /usr/share/nginx/html;
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
    }

    # 启用 gzip 压缩
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
}
```

### 构建和运行

```bash
# 构建镜像
docker build -t banana-ps-playground .

# 运行容器
docker run -d -p 80:80 --name banana-ps banana-ps-playground

# 查看日志
docker logs banana-ps

# 停止容器
docker stop banana-ps

# 删除容器
docker rm banana-ps
```

### 使用 Docker Compose

```yaml
# docker-compose.yml
version: '3.8'

services:
  web:
    build: .
    ports:
      - "80:80"
    restart: unless-stopped
```

```bash
# 启动
docker-compose up -d

# 停止
docker-compose down
```

---

## 🖥️ 自己的服务器部署

### 使用 Nginx

1. **安装 Nginx**

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install nginx

# CentOS/RHEL
sudo yum install nginx
```

2. **上传构建文件**

```bash
# 本地构建
npm run build

# 上传到服务器
scp -r dist/* user@server:/var/www/banana-ps/
```

3. **配置 Nginx**

```nginx
# /etc/nginx/sites-available/banana-ps
server {
    listen 80;
    server_name your-domain.com;
    root /var/www/banana-ps;
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
    }

    # 启用 gzip
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml;

    # 缓存静态资源
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

4. **启用站点**

```bash
# 创建符号链接
sudo ln -s /etc/nginx/sites-available/banana-ps /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重启 Nginx
sudo systemctl restart nginx
```

5. **配置 HTTPS（使用 Let's Encrypt）**

```bash
# 安装 Certbot
sudo apt install certbot python3-certbot-nginx

# 获取证书
sudo certbot --nginx -d your-domain.com

# 自动续期
sudo certbot renew --dry-run
```

### 使用 Apache

1. **安装 Apache**

```bash
sudo apt install apache2
```

2. **配置虚拟主机**

```apache
# /etc/apache2/sites-available/banana-ps.conf
<VirtualHost *:80>
    ServerName your-domain.com
    DocumentRoot /var/www/banana-ps

    <Directory /var/www/banana-ps>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>

    # 重写规则
    <IfModule mod_rewrite.c>
        RewriteEngine On
        RewriteBase /
        RewriteRule ^index\.html$ - [L]
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule . /index.html [L]
    </IfModule>

    ErrorLog ${APACHE_LOG_DIR}/banana-ps-error.log
    CustomLog ${APACHE_LOG_DIR}/banana-ps-access.log combined
</VirtualHost>
```

3. **启用站点**

```bash
# 启用必要的模块
sudo a2enmod rewrite

# 启用站点
sudo a2ensite banana-ps

# 重启 Apache
sudo systemctl restart apache2
```

---

## 🔒 安全配置

### 1. 保护 API 密钥

**方法 1：使用后端代理**

创建一个简单的 Node.js 后端：

```javascript
// server.js
const express = require('express');
const { GoogleGenAI } = require('@google/genai');

const app = express();
app.use(express.json());

const ai = new GoogleGenAI({ 
  apiKey: process.env.GEMINI_API_KEY 
});

app.post('/api/generate', async (req, res) => {
  try {
    const { prompt, images } = req.body;
    const result = await ai.models.generateContent({
      model: 'gemini-2.5-flash-image',
      contents: { parts: [{ text: prompt }, ...images] },
    });
    res.json(result);
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

app.listen(3001, () => {
  console.log('API proxy running on port 3001');
});
```

**方法 2：使用 Serverless Functions**

Vercel Functions 示例：

```typescript
// api/generate.ts
import { GoogleGenAI } from '@google/genai';

export default async function handler(req, res) {
  const ai = new GoogleGenAI({ 
    apiKey: process.env.GEMINI_API_KEY 
  });
  
  const { prompt } = req.body;
  const result = await ai.models.generateContent({
    model: 'gemini-2.5-flash',
    contents: prompt,
  });
  
  res.json(result);
}
```

### 2. 配置 CORS

```nginx
# Nginx
add_header Access-Control-Allow-Origin "https://your-domain.com";
add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
add_header Access-Control-Allow-Headers "Content-Type, Authorization";
```

### 3. 配置 CSP（内容安全策略）

```html
<!-- index.html -->
<meta http-equiv="Content-Security-Policy" 
      content="default-src 'self'; 
               script-src 'self' 'unsafe-inline'; 
               style-src 'self' 'unsafe-inline'; 
               img-src 'self' data: https:; 
               connect-src 'self' https://generativelanguage.googleapis.com;">
```

### 4. 配置速率限制

```nginx
# Nginx
limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;

location /api/ {
    limit_req zone=api burst=20 nodelay;
}
```

---

## 📊 性能优化

### 1. 启用压缩

```nginx
# Nginx
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_types text/plain text/css text/xml text/javascript 
           application/x-javascript application/xml+rss 
           application/json application/javascript;
```

### 2. 配置缓存

```nginx
# Nginx
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
}

location ~* \.(html)$ {
    expires -1;
    add_header Cache-Control "no-cache, no-store, must-revalidate";
}
```

### 3. 使用 CDN

推荐的 CDN 服务：
- Cloudflare（免费）
- AWS CloudFront
- Fastly
- 阿里云 CDN

配置步骤：
1. 在 CDN 服务商创建分发
2. 将源站设置为你的服务器
3. 更新 DNS 记录指向 CDN
4. 配置缓存规则

---

## 🔍 监控和日志

### 1. 配置访问日志

```nginx
# Nginx
access_log /var/log/nginx/banana-ps-access.log combined;
error_log /var/log/nginx/banana-ps-error.log warn;
```

### 2. 使用分析工具

- Google Analytics
- Plausible Analytics（隐私友好）
- Umami（开源）

### 3. 错误监控

- Sentry（推荐）
- Rollbar
- Bugsnag

```typescript
// 集成 Sentry
import * as Sentry from "@sentry/react";

Sentry.init({
  dsn: "your-sentry-dsn",
  environment: "production",
});
```

---

## 🔄 持续集成/持续部署 (CI/CD)

### GitHub Actions 示例

```yaml
# .github/workflows/deploy.yml
name: Deploy to Production

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build
      run: npm run build
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        
    - name: Deploy to Vercel
      uses: amondnet/vercel-action@v20
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        vercel-org-id: ${{ secrets.ORG_ID }}
        vercel-project-id: ${{ secrets.PROJECT_ID }}
        vercel-args: '--prod'
```

---

## ✅ 部署检查清单

部署前请确认：

- [ ] 代码已推送到 GitHub
- [ ] 环境变量已正确配置
- [ ] 本地构建成功
- [ ] 本地预览正常
- [ ] API 密钥有效
- [ ] 所有功能测试通过
- [ ] 响应式布局正常
- [ ] 浏览器兼容性测试通过

部署后请检查：

- [ ] 网站可以正常访问
- [ ] 所有页面加载正常
- [ ] 图片生成功能正常
- [ ] AI 对话功能正常
- [ ] 资产库功能正常
- [ ] 移动端显示正常
- [ ] HTTPS 证书有效
- [ ] 性能指标良好

---

## 🆘 常见部署问题

### 问题 1：构建失败

**错误**：`npm run build` 失败

**解决**：
```bash
# 清除缓存
rm -rf node_modules package-lock.json
npm install
npm run build
```

### 问题 2：环境变量不生效

**错误**：API 密钥未定义

**解决**：
- 检查环境变量名称是否正确
- 确认在部署平台配置了环境变量
- 重新部署项目

### 问题 3：路由 404 错误

**错误**：刷新页面显示 404

**解决**：
- 配置服务器重写规则
- 所有路由都应该返回 `index.html`

### 问题 4：CORS 错误

**错误**：跨域请求被阻止

**解决**：
- 配置服务器 CORS 头
- 或使用后端代理

---

**文档版本**：v1.0  
**最后更新**：2025-10-27

祝部署顺利！如有问题，请查看 [常见问题文档](./常见问题.md) 或在 GitHub 提交 Issue。
