# 分析与增长方案（2025-10-25）

## 输入流程总览
- 选择效果后，`app/page.tsx` 更新 `selectedTransformation` 并控制输入区域与生成按钮可用性。
- `TransformationInputArea.tsx` 路由到具体输入组件：`SingleImageTransformation`、`MultiImageTransformation`、`ImageGridTransformation`、`VideoTransformation`、`TextToImageTransformation`。
- 点击“生成”触发 `enhancerStore.generateImage` 或 `enhancerStore.generateVideo`，统一管理进度、错误、历史与水印。

## 单图与蒙版
- `ImageEditorCanvas.tsx` 三层画布：
  - `imageCanvas` 显示图片；`maskCanvas` 绘制蒙版；`polygonPreviewCanvas` 预览与事件捕获。
  - 画布大小与容器一致，图片居中缩放；蒙版在容器坐标系绘制并通过 `toDataURL()` 回传。
  - 支持画笔与多边形、撤销、清空、笔刷大小；文件选择、拖拽及剪贴板粘贴。
- `SingleImageTransformation.tsx` 写入 `primaryImageUrl`、`maskDataUrl`，支持自定义提示与资产库导入。

## 多图与网格
- `MultiImageTransformation.tsx` 通过 `MultiImageUploader` 管理主/次两图，资产库单选导入并统一转换为 `File`。
- `ImageGridTransformation.tsx` 使用 `MultiImageGridUploader` 管理 `maxImages` 张图，支持多文件拖拽/选择、删除与资产库多选（受 `maxSelection` 限制）。

## 文生图与视频
- `TextToImageTransformation.tsx` 管理 `customPrompt` 与 `imageAspectRatio`（`1:1`、`16:9`、`9:16`、`4:3`、`3:4`）。
- `VideoTransformation.tsx` 管理视频提示与宽高比（`16:9`、`9:16`），可选初始图（禁用蒙版工具）。
- 生成按钮由 `app/page.tsx` 按效果类型与输入完整性动态控制。

## 服务层映射
- 编辑与生成主流程（`enhancerStore.generateImage`）：
  - 风格模仿：`generateStyleMimicImageAction(content, style)` → `geminiService.generateStyleMimicImage`，先用 `gemini-2.5-flash` 生成风格描述，再调用 `editImage` 应用到内容图。
  - 文生图：`generateImageFromTextAction(prompt, aspectRatio, numImages)` → `imagen-4.0-generate-001`。
  - 其他编辑：`editImageAction(prompt, imageParts, maskBase64)` → `gemini-2.5-flash-image`（主图优先、蒙版其次、参考图再次），返回图片与可选文本。
- 批量变体：简单编辑且 `numImages > 1` 并行调用 N 次，聚合为候选；`imageOptions` 供用户选择。
- 水印：非高级模式下先嵌入不可见水印，再叠加可见水印（`embedWatermark`、`addVisibleWatermark`）。

## 关键实现细节与潜在问题
- 蒙版分辨率与主图不一致：
  - 现状：蒙版基于容器尺寸，而主图有更高自然像素；可能带来定位偏差与边缘质量下降。
  - 风险：高分辨率主图或复杂选区下，局部编辑精准度下降。
- 蒙版色彩语义：
  - 当前使用主题主色半透明涂抹/填充；更标准为白/黑二值或 alpha 明确表达选区，利于模型识别。
- 参考图顺序：
  - `editImage` 第一部分始终为主图，其后蒙版与参考图，符合 store 构造；需保持一致性。

## 优化方案（技术实现建议）
- 蒙版像素对齐到主图尺寸：
  - 在 `onMaskChange` 中使用离屏画布（大小设为 `image.width × image.height`），将容器蒙版用 `drawImage` 按比率缩放映射到原图尺寸，再 `toDataURL()` 回传。
- 蒙版二值化输出：
  - 绘制色改为纯白不透明（或纯黑），背景透明；减少颜色歧义，提高模型对选区的稳定识别。
- 高分辨率坐标映射：
  - 记录显示区域偏移与缩放比，将用户交互坐标从容器空间映射到原图空间绘制与撤销，确保边缘精度。
- 批量候选 UX 完成闭环：
  - 在候选卡片上显式提供“用作输入”CTA（调用 `useImageAsInput`），引导链式效果。
- 水印鲁棒性与性能：
  - 将水印处理串行化到可见水印完成后再更新 UI，或采用 Web Worker 降低主线程阻塞。

## 实施计划（阶段与里程碑）
- P0：蒙版像素对齐 + 二值化（精度提升最大）
  - 目标：保证局部编辑与主图像素完美对齐，明确二值蒙版语义。
  - 交付：`ImageEditorCanvas.tsx` 输出逻辑更新；`editImage` 参数保持不变。
- P1：坐标映射与撤销优化（高分图体验）
  - 目标：在 4K 甚至更大图下，笔触与多边形边缘更稳定。
  - 交付：统一原图空间绘制，撤销历史基于原图空间快照。
- P2：批量候选闭环 UX
  - 目标：提升多变体选择后继续创作的效率与可见性。
  - 交付：候选卡片添加“用作输入”入口、提示文案与动效。
- P3：水印与性能
  - 目标：减少水印处理对交互的影响；异常时回退策略。
  - 交付：Worker 化或时序优化；错误捕获与提示。

## 验证清单（建议测试）
- 蒙版对齐 A/B：同一张高分辨率图，用容器尺寸蒙版 vs 原图尺寸蒙版对比局部编辑效果。
- 文生图宽高比稳定性：`imagen-4.0` 输出在不同 `aspectRatio` 下的合规性验证。
- 风格模仿一致性：不同数量与顺序的参考图下，输出稳定性对比。
- 批量候选交互：多变体生成后选择、复用输入的链路顺畅性与错误处理。

## 未实现项提示（需要补齐）
- `TopAppBar.tsx`：下载与删除为占位（`alert`）。
- `ImagePreviewModal.tsx`：分享失败路径存在 `alert("无法分享图片")` 占位。

## 结论
- 当前输入与服务层架构清晰、可扩展；首要瓶颈在于蒙版与主图像素对齐与蒙版语义。优先完成 P0 可显著提升局部编辑质量；随后循序优化坐标映射与 UX 闭环，保证体验与性能稳健提升。