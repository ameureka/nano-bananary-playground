# 🛠️ 开发文档

本文档面向开发者，介绍如何扩展和定制香蕉PS乐园。

## 📁 项目结构

```
香蕉PS乐园-(banana-ps-playground)/
├── app/                          # 页面路由
│   ├── layout.tsx               # 根布局组件
│   ├── page.tsx                 # 增强器主页
│   ├── chat/page.tsx            # AI 对话页面
│   └── library/page.tsx         # 资产库页面
│
├── components/                   # React 组件
│   ├── common/                  # 通用组件
│   ├── features/                # 功能模块组件
│   └── layout/                  # 布局组件
│
├── services/                     # API 服务层
│   └── geminiService.ts        # Gemini API 封装
│
├── store/                        # Zustand 状态管理
│   ├── enhancerStore.ts        # 增强器状态
│   ├── chatStore.ts            # 对话状态
│   ├── assetLibraryStore.ts    # 资产库状态
│   ├── uiStore.ts              # UI 状态
│   └── logStore.ts             # 日志记录
│
├── i18n/                         # 国际化
│   ├── context.tsx             # i18n 上下文
│   ├── translations.ts         # 翻译配置
│   ├── zh.ts / en.ts           # 语言文件
│   ├── zh-ui.ts / en-ui.ts     # UI 翻译
│   └── zh-effects.ts / en-effects.ts  # 效果翻译
│
├── lib/                          # 业务逻辑层
│   └── actions.ts              # API 调用封装
│
├── utils/                        # 工具函数
│   ├── fileUtils.ts            # 文件处理
│   └── env.ts                  # 环境变量管理
│
├── styles/                       # 全局样式
│   └── globals.css             # Material Design 3 主题
│
├── theme/                        # 主题管理
│   └── context.tsx             # 主题上下文
│
├── constants.ts                  # 常量定义（86种效果配置）
├── types.ts                      # TypeScript 类型定义
├── providers.tsx                 # 全局 Provider 组合
├── App.tsx                       # 应用入口
├── index.tsx                     # React 渲染入口
├── vite.config.ts               # Vite 配置
└── tsconfig.json                # TypeScript 配置
```

## 🎨 添加新效果

### 步骤 1：确定效果类型

首先确定你的效果属于哪种类型：

| 类型 | 说明 | 示例 |
|------|------|------|
| Type 1 | 单图标准效果 | 乐高小人仔、高清增强 |
| Type 2 | 多图网格效果 | 拍立得合照 |
| Type 3 | 双图多模态效果 | 姿势迁移、风格模仿 |
| Type 4 | 风格模仿效果 | 风格模仿（特殊） |
| Type 5 | 两步处理效果 | 配色方案 |
| Type 6 | 视频生成效果 | 视频生成 |
| Type 7 | 多步视频效果 | 动态拍立得 |

### 步骤 2：在 constants.ts 中添加配置

```typescript
// constants.ts
{
  key: "myNewEffect",                    // 唯一标识
  titleKey: "transformations.effects.myNewEffect.title",
  descriptionKey: "transformations.effects.myNewEffect.description",
  prompt: "Your AI prompt here...",      // 发送给 Gemini 的提示词
  icon: "auto_awesome",                  // Material Symbols 图标名
  
  // 根据类型添加特殊属性
  // maxImages: 4,                       // Type 2: 多图网格
  // isMultiImage: true,                 // Type 3: 双图多模态
  // isStyleMimic: true,                 // Type 4: 风格模仿
  // isTwoStep: true,                    // Type 5: 两步处理
  // stepTwoPrompt: "...",               // Type 5: 第二步提示
  // isVideo: true,                      // Type 6: 视频生成
  // isMultiStepVideo: true,             // Type 7: 多步视频
  // videoPrompt: "...",                 // Type 7: 视频提示
}
```

### 步骤 3：添加翻译

**中文翻译** (`i18n/zh-effects.ts`):
```typescript
myNewEffect: { 
  title: "我的新效果", 
  description: "效果描述..." 
}
```

**英文翻译** (`i18n/en-effects.ts`):
```typescript
myNewEffect: { 
  title: "My New Effect", 
  description: "Effect description..." 
}
```

**如果是多图效果，还需要添加上传器翻译**:
```typescript
myNewEffect: {
  title: "...",
  description: "...",
  uploader1Title: "主图",
  uploader1Desc: "上传要编辑的图片",
  uploader2Title: "参考图",
  uploader2Desc: "上传参考图片"
}
```

### 步骤 4：测试效果

1. 重启开发服务器（如果需要）
2. 在效果选择器中找到新效果
3. 测试各种输入情况
4. 检查错误处理

### 示例：添加一个简单的单图效果

```typescript
// constants.ts - 在 TRANSFORMATIONS 数组中添加
{
  key: "category_artistic",
  titleKey: "transformations.categories.effects.title",
  icon: "auto_awesome",
  items: [
    // ... 其他效果
    {
      key: "oilPainting",
      titleKey: "transformations.effects.oilPainting.title",
      prompt: "Transform this image into a classical oil painting with visible brushstrokes, rich colors, and a textured canvas appearance.",
      icon: "palette",
      descriptionKey: "transformations.effects.oilPainting.description"
    }
  ]
}
```

```typescript
// i18n/zh-effects.ts
oilPainting: {
  title: "油画风格",
  description: "将图片转换为经典油画，带有明显的笔触和丰富的色彩"
}

// i18n/en-effects.ts
oilPainting: {
  title: "Oil Painting",
  description: "Transform the image into a classical oil painting with visible brushstrokes"
}
```

## 🔧 修改现有功能

### 修改效果提示词

直接在 `constants.ts` 中修改 `prompt` 字段：

```typescript
{
  key: "pixelArt",
  prompt: "Redraw the image in a retro 8-bit pixel art style with vibrant colors.",
  // 修改为：
  prompt: "Redraw the image in a retro 16-bit pixel art style with smooth gradients and detailed sprites.",
}
```

### 修改生成参数

在 `services/geminiService.ts` 中修改 API 调用参数：

```typescript
// 修改图片生成的默认配置
const config = {
  numberOfImages: numImages,
  outputMimeType: 'image/png',
  aspectRatio: aspectRatio !== 'Auto' ? aspectRatio : undefined,
  // 添加新参数
  // negativePrompt: "blurry, low quality",
  // guidanceScale: 7.5,
};
```

### 添加新的状态

在相应的 store 中添加新状态：

```typescript
// store/enhancerStore.ts
export interface EnhancerState {
  // ... 现有状态
  myNewState: string;  // 添加新状态
}

export interface EnhancerActions {
  // ... 现有操作
  setMyNewState: (value: string) => void;  // 添加新操作
}

// 在 create 函数中实现
export const useEnhancerStore = create<EnhancerStore>()(
  persist(
    (set, get) => ({
      // ... 现有实现
      myNewState: '',
      setMyNewState: (value) => set({ myNewState: value }),
    }),
    // ...
  )
);
```

## 🎨 自定义样式

### 修改主题颜色

在 `styles/globals.css` 中修改 Material Design 3 颜色令牌：

```css
:root {
  /* 主色调 */
  --md-sys-color-primary: #6750A4;
  --md-sys-color-on-primary: #FFFFFF;
  
  /* 修改为你的品牌色 */
  --md-sys-color-primary: #FF6B6B;
  --md-sys-color-on-primary: #FFFFFF;
}
```

### 添加新的组件样式

```css
/* styles/globals.css */
.my-custom-component {
  background-color: var(--md-sys-color-surface);
  color: var(--md-sys-color-on-surface);
  border-radius: 12px;
  padding: 1rem;
}
```

### 修改布局

在 `app/page.tsx` 中修改主页布局：

```typescript
// 修改网格列数
<div style={{
  display: 'grid',
  gridTemplateColumns: 'repeat(auto-fit, minmax(350px, 1fr))',  // 当前
  // 修改为固定两列
  gridTemplateColumns: '1fr 1fr',
  gap: '2rem'
}}>
```

## 🌐 添加新语言

### 步骤 1：创建语言文件

```typescript
// i18n/ja.ts (日语示例)
import { jaUI } from './ja-ui';
import { jaEffects } from './ja-effects';

export const ja = {
  ...jaUI,
  transformations: {
    categories: { /* ... */ },
    effects: jaEffects,
  }
};
```

### 步骤 2：创建翻译文件

```typescript
// i18n/ja-ui.ts
export const jaUI = {
  app: {
    title: "バナナPSプレイグラウンド",
    generateImage: "画像を生成",
    // ... 其他翻译
  }
};

// i18n/ja-effects.ts
export const jaEffects = {
  pixelArt: {
    title: "ピクセルアート",
    description: "レトロな8ビットピクセルアートスタイルに変換"
  },
  // ... 其他效果翻译
};
```

### 步骤 3：注册语言

```typescript
// i18n/translations.ts
import { zh } from './zh';
import { en } from './en';
import { ja } from './ja';  // 导入新语言

export const translations = {
  zh,
  en,
  ja,  // 注册新语言
};

export type Language = 'zh' | 'en' | 'ja';  // 添加类型
```

### 步骤 4：更新语言切换器

```typescript
// components/LanguageSwitcher.tsx
const languages: { code: Language; label: string }[] = [
  { code: 'zh', label: '中文' },
  { code: 'en', label: 'English' },
  { code: 'ja', label: '日本語' },  // 添加新语言
];
```

## 🔌 集成新的 AI 模型

### 添加新的 API 服务

```typescript
// services/newAiService.ts
export async function generateWithNewModel(
  prompt: string,
  options: any
): Promise<GeneratedContent> {
  // 实现新模型的 API 调用
  const response = await fetch('https://api.newai.com/generate', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${getApiKey()}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ prompt, ...options }),
  });
  
  const data = await response.json();
  
  return {
    imageUrl: data.imageUrl,
    text: data.text,
  };
}
```

### 在 actions.ts 中封装

```typescript
// lib/actions.ts
import { generateWithNewModel } from '../services/newAiService';

export async function generateWithNewModelAction(
  prompt: string,
  options: any
): Promise<GeneratedContent> {
  try {
    return await generateWithNewModel(prompt, options);
  } catch (error) {
    console.error('Error in generateWithNewModelAction:', error);
    throw error;
  }
}
```

### 在 store 中使用

```typescript
// store/enhancerStore.ts
generateWithNewModel: async () => {
  const { customPrompt } = get();
  set({ isGenerating: true, error: null });
  
  try {
    const result = await generateWithNewModelAction(customPrompt, {});
    set({ generatedContent: result });
  } catch (err) {
    set({ error: err.message });
  } finally {
    set({ isGenerating: false });
  }
}
```

## 📦 添加新的依赖

### 安装依赖

```bash
npm install package-name
npm install --save-dev @types/package-name  # 如果需要类型定义
```

### 在代码中使用

```typescript
import { someFunction } from 'package-name';

// 使用新依赖
const result = someFunction();
```

### 更新文档

在 `package.json` 中添加依赖说明：

```json
{
  "dependencies": {
    "package-name": "^1.0.0"  // 添加说明注释
  }
}
```

## 🧪 测试

### 手动测试清单

创建测试清单文件：

```markdown
# 测试清单

## 图像增强器
- [ ] 单图效果正常工作
- [ ] 多图网格效果正常工作
- [ ] 双图效果正常工作
- [ ] 蒙版编辑功能正常
- [ ] 错误处理正确显示

## AI 对话
- [ ] 文本对话正常
- [ ] 图片上传和分析正常
- [ ] 图片生成正常
- [ ] 消息编辑和重新生成正常

## 资产库
- [ ] 图片自动保存
- [ ] 批量操作正常
- [ ] 用作输入功能正常

## 响应式
- [ ] 桌面端布局正常
- [ ] 移动端布局正常
- [ ] 平板端布局正常
```

### 添加单元测试（可选）

```bash
# 安装测试框架
npm install --save-dev vitest @testing-library/react @testing-library/jest-dom
```

```typescript
// __tests__/utils/fileUtils.test.ts
import { describe, it, expect } from 'vitest';
import { embedWatermark } from '../../utils/fileUtils';

describe('fileUtils', () => {
  it('should embed watermark in image', async () => {
    const imageUrl = 'data:image/png;base64,...';
    const watermarked = await embedWatermark(imageUrl, 'Test');
    expect(watermarked).toBeDefined();
    expect(watermarked).not.toBe(imageUrl);
  });
});
```

## 🚀 构建和部署

### 本地构建

```bash
# 构建生产版本
npm run build

# 预览生产版本
npm run preview
```

### 环境变量配置

```bash
# .env.local (开发环境)
GEMINI_API_KEY=your_dev_key

# .env.production (生产环境)
GEMINI_API_KEY=your_prod_key
```

### 部署到 Vercel

1. 在 Vercel 中导入 GitHub 仓库
2. 配置环境变量：
   - `GEMINI_API_KEY`: 你的 API 密钥
3. 点击部署

### 部署到 Netlify

1. 构建项目：`npm run build`
2. 在 Netlify 中创建新站点
3. 上传 `dist` 文件夹
4. 配置环境变量

### 部署到自己的服务器

```bash
# 1. 构建项目
npm run build

# 2. 上传 dist 文件夹到服务器
scp -r dist/* user@server:/var/www/html/

# 3. 配置 Nginx
server {
    listen 80;
    server_name your-domain.com;
    root /var/www/html;
    index index.html;
    
    location / {
        try_files $uri $uri/ /index.html;
    }
}
```

## 🐛 调试技巧

### 查看 API 调用日志

```typescript
// 在浏览器控制台
useLogStore.getState().logs
```

### 查看 Store 状态

```typescript
// 查看增强器状态
useEnhancerStore.getState()

// 查看对话状态
useChatStore.getState()

// 查看资产库状态
useAssetLibraryStore.getState()
```

### 开启详细日志

```typescript
// services/geminiService.ts
const DEBUG = true;  // 开启调试模式

if (DEBUG) {
  console.log('API Request:', request);
  console.log('API Response:', response);
}
```

### 使用 React DevTools

1. 安装 React DevTools 浏览器扩展
2. 打开开发者工具
3. 切换到 React 标签
4. 查看组件树和 Props
5. 使用 Profiler 分析性能

## 📚 代码规范

### TypeScript 规范

```typescript
// 使用明确的类型定义
interface MyComponentProps {
  title: string;
  count: number;
  onAction: () => void;
}

// 避免使用 any
const myFunction = (data: unknown) => {
  // 使用类型守卫
  if (typeof data === 'string') {
    // ...
  }
};

// 使用可选链和空值合并
const value = obj?.property ?? 'default';
```

### React 规范

```typescript
// 使用函数组件和 Hooks
const MyComponent: React.FC<Props> = ({ title }) => {
  const [state, setState] = useState('');
  
  useEffect(() => {
    // 副作用
  }, []);
  
  return <div>{title}</div>;
};

// 使用 memo 优化性能
export default React.memo(MyComponent);
```

### CSS 规范

```css
/* 使用 BEM 命名 */
.card {}
.card__header {}
.card__header--active {}

/* 使用 CSS 变量 */
.my-component {
  color: var(--md-sys-color-primary);
  padding: var(--spacing-md);
}

/* 避免深层嵌套 */
.parent .child {}  /* 最多2层 */
```

## 🔐 安全最佳实践

### API 密钥保护

```typescript
// ❌ 不要硬编码 API 密钥
const API_KEY = 'AIzaSy...';

// ✅ 使用环境变量
const API_KEY = import.meta.env.VITE_GEMINI_API_KEY;

// ✅ 在生产环境使用后端代理
const response = await fetch('/api/generate', {
  method: 'POST',
  body: JSON.stringify({ prompt }),
});
```

### 输入验证

```typescript
// 验证用户输入
const validatePrompt = (prompt: string): boolean => {
  if (!prompt || prompt.trim().length === 0) {
    return false;
  }
  if (prompt.length > 1000) {
    return false;
  }
  return true;
};
```

### XSS 防护

```typescript
// React 自动转义，但要注意 dangerouslySetInnerHTML
// ❌ 危险
<div dangerouslySetInnerHTML={{ __html: userInput }} />

// ✅ 安全
<div>{userInput}</div>
```

## 📖 参考资源

### 官方文档

- [React 文档](https://react.dev/)
- [TypeScript 文档](https://www.typescriptlang.org/docs/)
- [Vite 文档](https://vitejs.dev/)
- [Zustand 文档](https://zustand-demo.pmnd.rs/)
- [Google Gemini API 文档](https://ai.google.dev/docs)

### 设计资源

- [Material Design 3](https://m3.material.io/)
- [Material Symbols](https://fonts.google.com/icons)

### 社区资源

- [GitHub Discussions](https://github.com/ameureka/nano-bananary-playground/discussions)
- [Stack Overflow](https://stackoverflow.com/questions/tagged/react)

---

**文档版本**：v1.0  
**最后更新**：2025-10-27

如有问题或建议，欢迎在 GitHub 提交 Issue 或 Pull Request！
